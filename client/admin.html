<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adnet Console - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --gcp-blue: #1a73e8;
      --gcp-blue-hover: #1557b0;
      --gcp-dark: #202124;
      --gcp-gray-900: #3c4043;
      --gcp-gray-700: #5f6368;
      --gcp-gray-500: #80868b;
      --gcp-gray-300: #dadce0;
      --gcp-gray-100: #f1f3f4;
      --gcp-gray-50: #f8f9fa;
      --gcp-white: #ffffff;
      --gcp-green: #34a853;
      --gcp-yellow: #fbbc04;
      --gcp-red: #ea4335;
      --sidebar-width: 256px;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--gcp-gray-100);
      color: var(--gcp-gray-900);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--gcp-white);
      border-right: 1px solid var(--gcp-gray-300);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--gcp-gray-300);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--gcp-blue) 0%, #4285f4 100%);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .sidebar-title {
      font-family: 'Google Sans', sans-serif;
      font-size: 18px;
      font-weight: 500;
      color: var(--gcp-gray-900);
    }

    .sidebar-nav {
      flex: 1;
      padding: 8px 0;
      overflow-y: auto;
    }

    .nav-section {
      padding: 8px 0;
    }

    .nav-section-title {
      padding: 8px 24px;
      font-size: 11px;
      font-weight: 500;
      color: var(--gcp-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 10px 24px;
      color: var(--gcp-gray-700);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.15s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--gcp-gray-100);
    }

    .nav-item.active {
      background: #e8f0fe;
      color: var(--gcp-blue);
      font-weight: 500;
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      margin-right: 16px;
      fill: currentColor;
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      flex: 1;
      min-height: 100vh;
    }

    /* Top Header */
    .top-header {
      background: var(--gcp-white);
      border-bottom: 1px solid var(--gcp-gray-300);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .page-title {
      font-family: 'Google Sans', sans-serif;
      font-size: 22px;
      font-weight: 400;
      color: var(--gcp-gray-900);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      font-family: 'Google Sans', sans-serif;
    }

    .btn-primary {
      background: var(--gcp-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--gcp-blue-hover);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: var(--gcp-white);
      color: var(--gcp-blue);
      border: 1px solid var(--gcp-gray-300);
    }

    .btn-secondary:hover {
      background: var(--gcp-gray-50);
    }

    /* Content Area */
    .content-area {
      padding: 24px;
    }

    /* Metric Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--gcp-white);
      border-radius: 8px;
      padding: 20px;
      border: 1px solid var(--gcp-gray-300);
    }

    .metric-label {
      font-size: 12px;
      color: var(--gcp-gray-700);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .metric-value {
      font-family: 'Google Sans', sans-serif;
      font-size: 32px;
      font-weight: 400;
      color: var(--gcp-gray-900);
    }

    .metric-change {
      font-size: 12px;
      margin-top: 4px;
    }

    .metric-change.positive {
      color: var(--gcp-green);
    }

    .metric-change.negative {
      color: var(--gcp-red);
    }

    /* Cards */
    .card {
      background: var(--gcp-white);
      border-radius: 8px;
      border: 1px solid var(--gcp-gray-300);
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gcp-gray-300);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-family: 'Google Sans', sans-serif;
      font-size: 16px;
      font-weight: 500;
      color: var(--gcp-gray-900);
    }

    .card-body {
      padding: 20px;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 200px;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--gcp-gray-700);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid var(--gcp-gray-300);
      background: var(--gcp-gray-50);
    }

    .data-table td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--gcp-gray-300);
    }

    .data-table tr:hover {
      background: var(--gcp-gray-50);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.success {
      background: #e6f4ea;
      color: var(--gcp-green);
    }

    .status-badge.warning {
      background: #fef7e0;
      color: #b06000;
    }

    .status-badge.error {
      background: #fce8e6;
      color: var(--gcp-red);
    }

    .status-badge.info {
      background: #e8f0fe;
      color: var(--gcp-blue);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-dot.success { background: var(--gcp-green); }
    .status-dot.warning { background: var(--gcp-yellow); }
    .status-dot.error { background: var(--gcp-red); }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--gcp-gray-300);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gcp-gray-700);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .tab:hover {
      color: var(--gcp-blue);
    }

    .tab.active {
      color: var(--gcp-blue);
      border-bottom-color: var(--gcp-blue);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Mono text */
    .mono {
      font-family: 'Roboto Mono', monospace;
      font-size: 13px;
      color: var(--gcp-gray-700);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--gcp-gray-500);
    }

    .empty-state h3 {
      font-family: 'Google Sans', sans-serif;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--gcp-gray-700);
    }

    /* Link styles */
    a.table-link {
      color: var(--gcp-blue);
      text-decoration: none;
    }

    a.table-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">A</div>
      <span class="sidebar-title">Adnet Console</span>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <a href="admin" class="nav-item active">
          <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
          Dashboard
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Analytics</div>
        <a href="sponsor" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
          Campaigns
        </a>
        <a href="publisher" class="nav-item">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
          Publishers
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Settings</div>
        <a href="#" class="nav-item" onclick="loadData()">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Refresh Data
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="top-header">
      <h1 class="page-title">Admin Dashboard</h1>
    </header>

    <div class="content-area">
      <!-- Metrics - Compact Row -->
      <div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr);">
        <div class="metric-card">
          <div class="metric-label">Campaigns</div>
          <div class="metric-value" id="total-campaigns">-</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Batches</div>
          <div class="metric-value" id="total-batches">-</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Impressions</div>
          <div class="metric-value" id="total-impressions">-</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Clicks</div>
          <div class="metric-value" id="total-clicks">-</div>
        </div>
      </div>

      <!-- Activity Chart -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Activity Over Time</span>
          <div style="display: flex; align-items: center; gap: 16px; font-size: 13px;">
            <span class="status-badge" id="db-status" style="font-size: 11px;">
              <span class="status-dot success"></span>DB
            </span>
            <span class="status-badge" id="watcher-status" style="font-size: 11px;">
              <span class="status-dot success"></span>Watcher
            </span>
            <span class="mono" style="color: var(--gcp-gray-500);" id="factory-url">-</span>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 200px;">
            <canvas id="activityChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Tabbed Data -->
      <div class="card">
        <div class="card-header">
          <div class="tabs" style="border-bottom: none; margin-bottom: 0;">
            <button class="tab active" onclick="showTab('campaigns')">Campaigns</button>
            <button class="tab" onclick="showTab('batches')">Batches</button>
            <button class="tab" onclick="showTab('events')">Events</button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <!-- Campaigns Tab -->
          <div id="tab-campaigns" class="tab-content active">
            <div id="campaigns-container"></div>
          </div>

          <!-- Batches Tab -->
          <div id="tab-batches" class="tab-content">
            <div id="batches-container"></div>
          </div>

          <!-- Events Tab -->
          <div id="tab-events" class="tab-content">
            <div style="padding: 16px; border-bottom: 1px solid var(--gcp-gray-300); display: flex; gap: 12px;">
              <input type="text" id="event-filter-campaign" placeholder="Filter by Campaign ID" style="padding: 8px 12px; border: 1px solid var(--gcp-gray-300); border-radius: 4px; font-size: 14px; width: 200px;">
              <select id="event-filter-type" style="padding: 8px 12px; border: 1px solid var(--gcp-gray-300); border-radius: 4px; font-size: 14px;">
                <option value="">All Types</option>
                <option value="impression">Impressions</option>
                <option value="click">Clicks</option>
              </select>
              <button class="btn btn-primary" onclick="loadEvents()">Apply Filter</button>
            </div>
            <div id="events-container"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const FACTORY_URL = 'https://adnet.geistm.com';
    let activityChart;
    let allBatches = [];

    // Initialize chart
    function initCharts() {
      const activityCtx = document.getElementById('activityChart').getContext('2d');
      activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Impressions',
              data: [],
              borderColor: '#1a73e8',
              backgroundColor: 'rgba(26, 115, 232, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Clicks',
              data: [],
              borderColor: '#34a853',
              backgroundColor: 'rgba(52, 168, 83, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { usePointStyle: true, padding: 12 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f1f3f4' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    // Update chart with data
    function updateCharts(batches) {
      const dailyStats = {};
      let totalImpressions = 0, totalClicks = 0;

      batches.forEach(b => {
        const date = new Date(b.blockTimestamp).toISOString().split('T')[0];
        if (!dailyStats[date]) {
          dailyStats[date] = { impressions: 0, clicks: 0 };
        }
        dailyStats[date].impressions += b.impressions || 0;
        dailyStats[date].clicks += b.clicks || 0;
        totalImpressions += b.impressions || 0;
        totalClicks += b.clicks || 0;
      });

      const sortedDays = Object.keys(dailyStats).sort().slice(-14);

      activityChart.data.labels = sortedDays.map(d => {
        const date = new Date(d);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      activityChart.data.datasets[0].data = sortedDays.map(d => dailyStats[d].impressions);
      activityChart.data.datasets[1].data = sortedDays.map(d => dailyStats[d].clicks);
      activityChart.update();

      document.getElementById('total-impressions').textContent = formatNumber(totalImpressions);
      document.getElementById('total-clicks').textContent = formatNumber(totalClicks);
    }

    // Switch tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      if (tab === 'batches') loadBatches();
      if (tab === 'events') loadEvents();
    }

    // Load all data
    async function loadData() {
      try {
        const agentResponse = await fetch('/agent/geistm/adnet-agent/status');
        const agentStatus = await agentResponse.json();
        document.getElementById('factory-url').textContent = agentStatus.factory?.url || '-';

        await loadCampaigns();

        try {
          const adminResponse = await fetch(`${FACTORY_URL}/api/admin/status`, { credentials: 'include' });
          if (adminResponse.ok) {
            const adminData = await adminResponse.json();
            updateStatusBadge('db-status', adminData.database === 'connected', 'DB');
            updateStatusBadge('watcher-status', adminData.watcher?.running, 'Watcher');
          }

          const batchesResponse = await fetch(`${FACTORY_URL}/api/admin/batches?limit=1000`, { credentials: 'include' });
          if (batchesResponse.ok) {
            const batchesData = await batchesResponse.json();
            allBatches = batchesData.batches || [];
            document.getElementById('total-batches').textContent = formatNumber(allBatches.length);
            updateCharts(allBatches);
          }
        } catch (e) {
          console.log('Factory admin data not available');
        }
      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function updateStatusBadge(id, isOk, label) {
      const el = document.getElementById(id);
      if (isOk) {
        el.className = 'status-badge success';
        el.innerHTML = `<span class="status-dot success"></span>${label}`;
      } else {
        el.className = 'status-badge warning';
        el.innerHTML = `<span class="status-dot warning"></span>${label}`;
      }
    }

    // Load campaigns
    async function loadCampaigns() {
      try {
        const response = await fetch('/agent/geistm/adnet-agent/campaigns');
        const data = await response.json();
        const campaigns = data.campaigns || [];

        document.getElementById('total-campaigns').textContent = campaigns.length;

        const container = document.getElementById('campaigns-container');

        if (campaigns.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No campaigns found</h3><p>Create a campaign to get started</p></div>';
          return;
        }

        container.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Campaign ID</th>
                <th>Brand</th>
                <th>Promotions</th>
                <th>Contract</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${campaigns.map(c => `
                <tr>
                  <td><a href="sponsor?campaign=${c.id}" class="table-link mono">${c.id?.substring(0, 24)}...</a></td>
                  <td>${c.brand || 'Unknown'}</td>
                  <td>${c.promotions?.length || 0}</td>
                  <td class="mono">${c.contractAddress ? c.contractAddress.substring(0, 12) + '...' : 'Not deployed'}</td>
                  <td>
                    <span class="status-badge ${c.active ? 'success' : 'error'}">
                      <span class="status-dot ${c.active ? 'success' : 'error'}"></span>
                      ${c.active ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load campaigns:', error);
      }
    }

    // Load batches
    async function loadBatches() {
      const container = document.getElementById('batches-container');
      try {
        const response = await fetch(`${FACTORY_URL}/api/admin/batches?limit=50`, { credentials: 'include' });

        if (!response.ok) {
          container.innerHTML = '<div class="empty-state"><h3>Authentication Required</h3><p>Connect your wallet to view batch data</p></div>';
          return;
        }

        const data = await response.json();
        const batches = data.batches || [];

        if (batches.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No batches recorded</h3><p>Batches will appear here once events are submitted</p></div>';
          return;
        }

        container.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Campaign</th>
                <th>Publisher</th>
                <th>Impressions</th>
                <th>Clicks</th>
                <th>Reach</th>
                <th>IPFS</th>
              </tr>
            </thead>
            <tbody>
              ${batches.map(b => `
                <tr>
                  <td>${new Date(b.blockTimestamp).toLocaleString()}</td>
                  <td class="mono">${b.campaignId?.substring(0, 16)}...</td>
                  <td class="mono">${b.publisher?.substring(0, 12)}...</td>
                  <td>${formatNumber(b.impressions || 0)}</td>
                  <td>${formatNumber(b.clicks || 0)}</td>
                  <td>${formatNumber(b.reach || 0)}</td>
                  <td><a href="https://rootz.digital/ipfs/${b.ipfsCID}" target="_blank" class="table-link mono">${b.ipfsCID?.substring(0, 12)}...</a></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load batches:', error);
      }
    }

    // Load events
    async function loadEvents() {
      const container = document.getElementById('events-container');
      const campaignFilter = document.getElementById('event-filter-campaign').value;
      const typeFilter = document.getElementById('event-filter-type').value;

      let url = `${FACTORY_URL}/api/admin/events?limit=100`;
      if (campaignFilter) url += `&campaignId=${campaignFilter}`;
      if (typeFilter) url += `&type=${typeFilter}`;

      try {
        const response = await fetch(url, { credentials: 'include' });

        if (!response.ok) {
          container.innerHTML = '<div class="empty-state"><h3>Authentication Required</h3><p>Connect your wallet to view event data</p></div>';
          return;
        }

        const data = await response.json();
        const events = data.events || [];

        if (events.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No events found</h3><p>Events will appear here once batches are processed</p></div>';
          return;
        }

        container.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Campaign</th>
                <th>Promotion</th>
                <th>Publisher</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody>
              ${events.map(e => `
                <tr>
                  <td>${new Date(e.timestamp).toLocaleString()}</td>
                  <td>
                    <span class="status-badge ${e.type === 'click' ? 'success' : 'info'}">
                      ${e.type || '-'}
                    </span>
                  </td>
                  <td class="mono">${e.campaignId?.substring(0, 12)}...</td>
                  <td class="mono">${e.promotionId?.substring(0, 12)}...</td>
                  <td class="mono">${e.publisher?.substring(0, 10)}...</td>
                  <td class="mono">${e.userAddress?.substring(0, 10)}...</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load events:', error);
      }
    }

    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Initialize
    initCharts();
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
